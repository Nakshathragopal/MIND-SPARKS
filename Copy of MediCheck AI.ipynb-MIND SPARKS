"""
Prescription Text Analysis Tool
Author: Nakshathra
Description:
    This script analyzes prescription text using the Mistral API.
    It extracts:
    - Key medical details
    - Authenticity indicators
    - Doctor–Patient interaction style
    - Alerts (illegibility, missing dosage, contradictions)
"""

from mistralai import Mistral
from typing import Tuple
import os


def analyze_prescription_text(
    text: str, patient_age: str, language: str = "en"
) -> Tuple[str, str, str, str]:
    """
    Analyze a prescription text using the Mistral API.

    Args:
        text (str): The prescription text.
        patient_age (str): Age of the patient.
        language (str): Response language.

    Returns:
        Tuple with:
        - analysis_summary
        - authenticity_summary
        - interaction_summary
        - alerts_summary
    """

    client = Mistral(api_key=os.environ.get("MISTRAL_API_KEY"))

    prompt = f"""
You are a professional medical text–analysis system.
Analyze the following prescription text.

Prescription:
{text}

Patient Age: {patient_age}
Language: {language}

Provide 4 clear sections:
1. Key Details
2. Authenticity
3. Interaction Style
4. Alerts
"""

    response = client.responses.create(
        model="mistral-large-latest",
        input=prompt
    )

    output = response.output_text

    # --- Split output into 4 blocks ---
    sections = ["Key Details", "Authenticity", "Interaction Style", "Alerts"]
    extracted = []

    for sec in sections:
        index = output.find(sec)
        if index != -1:
            extracted.append(output[index:])
        else:
            extracted.append(f"{sec}: Not found")

    analysis_summary = extracted[0]
    authenticity_summary = extracted[1]
    interaction_summary = extracted[2]
    alerts_summary = extracted[3]

    return analysis_summary, authenticity_summary, interaction_summary, alerts_summary


if __name__ == "__main__":
    # Example test (can be removed later)
    text = "Tab Amoxicillin 500mg twice daily for 5 days. Paracetamol dosage missing."
    age = "25"

    a, b, c, d = analyze_prescription_text(text, age)

    print("\n=== KEY DETAILS ===")
    print(a)
    print("\n=== AUTHENTICITY ===")
    print(b)
    print("\n=== INTERACTION STYLE ===")
    print(c)
    print("\n=== ALERTS ===")
    print(d)